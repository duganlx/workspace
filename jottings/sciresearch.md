# Scientific Research

## 深度学习

### 研讨会

**MLNLP 学术研讨会|23 期 2024/01/28**

[arxiv](https://arxiv.org/)

### 论文

- [Attention Is All You Need](https://browse.arxiv.org/pdf/1706.03762.pdf)

## 股票

### 股市术语

仓位：仓位就是你持有的基金、股票、期货的市值占你的总资金的比例。比如你有一万元，买了五千元股票，那你的仓位是 50%。如果你全买了基金或股票，你就 _满仓_ 了。如果你全部赎回基金卖出股票，你就 _空仓_ 了

建仓/开仓，是指交易者新买入或新卖出一定数量的股票、基金或者期货合约

平仓，也就是股票、基金、期货的反向操作。通过买回已卖出的股票和期货，或卖出已买入股票和期货就叫平仓。

持仓：建仓之后尚没有平仓的合约，叫未平仓合约或者未平仓头寸，也叫持仓。交易者建仓之后可以选择两种方式了结期货合约：1. 择机平仓；2. 保留至最后交易日进行实物交割。

头寸：Position 也称“头衬” 就是款项、资金的意思

多头寸：银行当日的全部收付款中 _收入_ 大于 _支出_ 款项

缺头寸：_支出_ 大于 _收入_ 款项

斩头寸：预计这一类头寸的多与少的行为

调头寸：到处想方设法调进款项的行为

头寸松：暂时未用的款项大于需用量

头寸紧：资金需求量大于闲置量

_多头 Long Position_ 比如再期货交易中建仓时，买入期货合约后所持有的头寸叫多头头寸，简称多头；_空头 Short Position_ 卖出期货合约后所持有的头寸叫空头头寸，简称空头；商品未平仓多头合约与未平仓空头合约之间的差额就叫做净头寸。只是在期货交易中有这种做法。

_买空 Long_ 是指投资者用借入的资金买入证券；_卖空 Short_ 是指投资者自己没有证券而向他人借入证券后卖出。目前在我国叫做融资融券，投资者需缴纳一定的保证金，且特定股票才能做。

_买空交易_，在买空交易中，如果投资者认定某一证券价格将上升，想多买一些该证券但手头资金不足时，可以通过缴纳保证金向证券商借入资金（融资）买进证券，等待价格涨到一定程度时再卖出以获取价差。这一交易的特点是，投资人手里既无足够的资金，也不持有证券，所以称为买空交易。

_卖空交易_，当投资人认定某种证券价格将下跌时，可以通过缴纳一部分保证金向证券商（融券）借入证券卖出，等价格跌到一定程度后再买回同样证券交还借出者，以牟取价差。这一交易方式的特点是，投资者手里没有真正的证券，交易过程是先卖出后买入，所以称为卖空交易。

_空单止盈_：比如你在 3000 元做空，那么如果跌倒 2900 元，你就盈利了，此时你不想再持仓了，就平仓兑现盈利，那么就叫 空单止盈。

### MACD

平滑异同平滑平均线（Moving Average Convergence Divergence，MACD）Geral Appel 于 1979 年提出的，它是一项利用短期（常用为 12 日）移动平均线与长期（常用为 26 日）移动平均线之间的聚合与分离状况，对买进、卖出时机做出研判的技术指标。在现有的技术分析软件中，MACD 常用参数是快速平滑移动平均线为 12，慢速平滑移动平均线参数为 26. 此外，MACD 还有一个辅助指标柱状图（Bar）。在大多数期货技术分析软件中，柱状线是有颜色的，在低于 0 轴以下是绿色，高于 0 轴以上是红色，前者代表趋势较弱，后者代表趋势较强。

假设收盘价 `close = {p1, p2, ..., pn}`, 则 macd 计算如下

$$
ema_i(12) = \frac{2}{13} \times p_i + \frac{11}{13} \times ema_{i-1}(12), ema_1=p_1
$$

$$
ema_i(26) = \frac{2}{27} \times p_i + \frac{25}{27} \times ema_{i-1}(26), ema_1=p_1
$$

$$
dif_i = ema_i(12) - ema_i(26)
$$

$$
dea_i = \frac{2}{10} \times dif_i + \frac{8}{10} \times dea_{i-1}, dea_1=dif_1
$$

$$
macd_i = (dif_i - dea_i) \times 2
$$

代码实现

```py
# MACD 代码实现
import pandas as pd
import numpy as np

def calc_macd(close) -> pd.DataFrame:
    """
    计算平滑异同平均线 MACD
    """
    ema12, ema26 = [], []
    for ele in close.array:
        if len(ema12) == 0:
            ema12.append(ele)
            ema26.append(ele)
            continue

        pre_ema12, pre_ema26 = ema12[-1], ema26[-1]
        cur_ema12 = 2/13 * ele + 11/13 * pre_ema12
        cur_ema26 = 2/27 * ele + 25/27 * pre_ema26

        ema12.append(cur_ema12)
        ema26.append(cur_ema26)

    ema12 = pd.Series(ema12, name='EMA12')
    ema26 = pd.Series(ema26, name='EMA26')
    dif = pd.Series(ema12 - ema26, name='DIF')

    dea = []
    for ele in dif.array:
        if len(dea) == 0:
            dea.append(ele)
            continue

        pre_dif = dea[-1]
        cur_dea = 2/10 * ele + 8/10 * pre_dif
        dea.append(cur_dea)

    dea = pd.Series(dea, name='DEA')
    macd = pd.Series((dif - dea) * 2, name='MACD')

    df = pd.concat([dif, dea, macd], axis=1)
    return df

def rolling_df(df, window, func, name):
    """
    对Dataframe按一行为单位进行滚动, 并且生成结果Series
    """
    res = []
    for i in range(len(df)):
        window_df = df.iloc[(i-window+1):i+1, :]

        if window_df.empty:
            res.append(np.nan)
            continue

        this_res = func(window_df)
        res.append(this_res)

    res = pd.Series(res, name=name)
    return res
```

#### 研究

通过 macd 的计算公式，我们可以到 白线 dif 是用 12 日的指数移动平均线减去 26 日的指数移动平均线。黄线 dea 是在 dif 的基础上求了个 9 日的指数移动平均线。利用移动平均线其实就是平滑曲线，所以 dif 会比 dea 反应更加剧烈一点，我习惯用快慢线来描述：dif 快线、dea 慢线。柱状图 macd 则是用快线减去慢线所得到的差值（扩大两倍）。

这么看来，其实 macd 有点类似套娃的过程了。指数移动平均线 EMA 比普通的移动平均线会更加侧重当日的股价变化，dif 用 12 日的 EMA（快线）减去 26 日 EMA（慢线），其实就有三种情况，分别是大于 0、等于 0、小于 0 三种情况。当股价处于上升状态时，dif 大于 0；当股价下跌时，dif 小于 0。而 dif 等于 0 其实就是移动平均线的金叉或死叉信号，当 dif 从负转零，即为金叉，反之为死叉。当 dif 的绝对值变大时，代表长短期均线的开口越大，代表短期股价的上涨或下跌呈现加速状态，反之则呈现减弱态势。

dea 是在 dif 上计算了一次均值。dif 上穿 dea 时形成金叉，根据金叉位置与零轴的关系可以分为零上金叉和零下金叉。零上金叉意味着 dif 在变大，股价的长短期均线距离在变大，股价上涨势头越来越猛；而零下金叉即为 dif 的绝对值在变小，股价长短期均线距离在变小，股价下跌势头变弱。dif 下穿 dea 时形成死叉。零上死叉，意味着 dif 正在变小，股价长短期均线的距离正在变小，股价上涨势头变弱；零下死叉，意味着 dif 绝对值在变大，长短期均线的距离变大，股价下跌势头越来越强。

柱子 macd 就是为了更加明显的看 dif 和 dea 之间的差值。

**参考**

1. [【微信公众号】为什么骗子推荐的股票总是涨？](https://mp.weixin.qq.com/s?__biz=MzAxMjM4MTEwNg==&mid=2651704635&idx=1&sn=49048b7810552fd91f08d654bf75fe7f&chksm=804bd3e6b73c5af0f38b23376b7579b1bbf75eb4cc918227dd880978fe9d9c7e14835c0940d0&scene=21&poc_token=HK_aOWWjQWolLIigvhayAevZmBoQ7VnR98YUgnpY)
2. [【知乎】macd 指标的内在逻辑是什么？](https://www.zhihu.com/question/29954111)
3. [【富途牛牛】什么是指数平滑异同移动平均线（MACD）？](https://www.futunn.com/learn/detail-what-is-the-exponential-smoothing-moving-average-macd-63265-0)
4. [【雪球·天街看锦】指标之王——MACD 的所有用法，终于有一文完完整整明明白白讲清楚了！](https://xueqiu.com/6611881023/124133829)

### MA

移动平均线，可分为简单移动平均线 SMA 和 指数移动平均线 EMA，假设收盘价 `close = {p1，p2，...，pn}`，n 日的移动平均线计算公式如下

$$
sma_i = \frac{p_{i-n+1} + p_{i-n+2} + ... + p_{i}}{n}
$$

$$
ema_i = \frac{2}{n+1} \times p_i + \frac{n-1}{n+1} \times ema_{i-1}
$$

代码实现如下

```python
import pandas as pd

def calc_sma(series, window) -> pd.Series:
    """
    计算简单移动平均线 MA
    """
    ma = series.rolling(window=window).mean()
    ma.name = f'MA{window}'

    return ma

def calc_expma(close, n):
    """
    计算指数移动平均线 EXPMA
    """
    expma = []
    for ele in close.array:
        if len(expma) == 0:
            expma.append(ele)
            continue

        prev_expma = expma[-1]
        alpha = 2 / (n+1)
        cur_expma = alpha * ele + (1-alpha) * prev_expma

        expma.append(cur_expma)

    expma = pd.Series(expma, name=f'EXPMA{n}')
    return expma
```

#### 研究

> 来自：沪深 A 股市场中趋势投资有效性研究——基于移动平均线策略,王晨阳(三峡大学),商业经济,10.19905/j.cnki.syjj1982.2019.09.066
>
> 该作者的基本观点是 短期 MA 上穿 长期 MA 时 产生买入信号，而 短期 MA 下穿 长期 MA 时产生卖出信号. 其添加了 `X` 百分比来调整触发的位置. 但令人沮丧的是，实验的参数并没有完全写出来(`X`未提及)。另外，选取的三组参数也没有进一步的横向对比。不够严谨，论证也不够充分，参考价值有限。

产生买入或保持多头头寸的交易信号：

$$
\frac{1}{S} \sum_{i=1}^{s} P_{t-i} > (1 + X) \times \frac{1}{L} \sum_{i=1}^{L} P_{t-i}
$$

产生卖出或保持零头寸的交易信号：

$$
\frac{1}{S} \sum_{i=1}^{s} P_{t-i} < (1 + X) \times \frac{1}{L} \sum_{i=1}^{L} P_{t-i}
$$

其中，$P_{t-i}$ 表示第 (t-i) 天的收盘价，S 表示 MA 短期期限，L 表示 MA 长期期限，X 表示百分比幅度.

作者在 沪深 300 指数和中证 500 指数上进行了实验，选取的时间为 2005 年 6 月 5 日至 2019 年 1 月 4 日，对比了采用该策略以及 _直接买入持有_ (策略 B) 所带来的收益情况. 并做了三组实验，参数分别是 `{S=1,L=10,X=?}`，`{S=10,L=30,X=?}`，`{S=21,L=28,X=?}`. 他还将时间按照 _非参数法_ (通过判定时间序列从扩张转为收缩及从收缩转为扩张时的波峰和波谷来判定) 划分了牛熊市，如下所示

| 命名         | 时间范围                                   |
| ------------ | ------------------------------------------ |
| 第一次牛市   | 2005 年 6 月 6 日 至 2007 年 10 月 16 日   |
| 第一次熊市   | 2007 年 10 月 16 日 至 2008 年 10 月 28 日 |
| 第二次牛市   | 2008 年 10 月 29 日 至 2009 年 8 月 4 日   |
| 第二次熊市   | 2009 年 8 月 5 日 至 2014 年 7 月 21 日    |
| 第三次牛市   | 2014 年 7 月 22 日 至 2015 年 6 月 12 日   |
| 第一次震荡期 | 2015 年 6 月 12 日 至 2007 年 1 月 4 日    |

实验结果表明，该策略在熊市和震荡期的收益好于 策略 B，而在牛市则不如 策略 B. 单纯看累计收益率的话，该策略优于 策略 B.

### KDJ

随机指标（KDJ）由 George C. Lane 创建. 它综合了动量观念、强弱指标及移动平均线的优点, 用来度量股价脱离价格正常范围的变异程度. 该指标总共包含三根线, 分别是 K, D, J 线

假设收盘价 `CLOSE = {close_1, close_2,..., close_n}`，最高价 `HIGH = {high_1, high_2, ..., high_n}`，最低价 `LOW = {low_1, low_2, ..., low_n}`，则 kdj 计算如下

$$
lowest\_low_i = min\{low_{i-8},\ low_{i-7},\ ...,\ low_{i}\}
$$

$$
highest\_high_i = max\{high_{i-8},\ high_{i-7},\ ...,\ high_{i}\}
$$

$$
rsv_i = \frac{close_i - lowest\_low_i}{highest\_high_i - lowest\_low_i} \times 100
$$

$$
k_i = \frac{2}{3} \times k_{i-1} + \frac{1}{3} \times rsv_i,\ k_1=50
$$

$$
d_i = \frac{2}{3} \times d_{i-1} + \frac{1}{3} \times k_i,\ d_1=50
$$

$$
j_i = 3 \times k_i - 2 \times d_i
$$

代码实现

```py
# KDJ 代码实现
import pandas as pd

def calc_kdj(close, high, low) -> pd.DataFrame:
    """
    计算 KDJ
    """
    lowest_low = low.rolling(window=9, min_periods=1).min()
    highest_low = high.rolling(window=9, min_periods=1).max()
    rsv = (close - lowest_low) / (highest_low - lowest_low) * 100
    rsv = pd.Series(rsv, name='RSV')

    k, d, j = [], [], []
    for ele in rsv.array:
        if len(k) == 0:
            # 初始值50
            k.append(50)
            d.append(50)
            j.append(50)
            continue

        pre_k = k[-1]
        cur_k = (2 * pre_k + ele) / 3

        pre_d = d[-1]
        cur_d = (2 * pre_d + cur_k) / 3

        cur_j = 3 * cur_k - 2 * cur_d

        k.append(cur_k)
        d.append(cur_d)
        j.append(cur_j)

    k = pd.Series(k, name='K')
    d = pd.Series(d, name='D')
    j = pd.Series(j, name='J')

    df = pd.concat([k, d, j], axis=1)

    return df
```

根据 kdj 的计算公式，先来推算下取值范围。rsv 计算的分子是 _收盘价_（`close`） 减去 _窗口内的最低价_（`wins_min(low)`），分母是 _窗口内的最高价_ （`wins_max(high)`） 与 _窗口内的最低价_ 相减。分母代表窗口内最大波动范围，必然大于 0。分子收盘价 ≥ 窗口内的最低价。所以 rsv 的取值范围为 [0, 100]，k 利用 _昨日 k_ 平滑 rsv，d 利用 _昨日 d_ 平滑 k。由于 _初始 k_（`k1`）为 50 和 rsv 的取值范围为 [0, 100]，k 必然也是一个在[0, 100]内的数，因为 d 计算与 k 很类似，所以也是一样是[0, 100]内的数。而 j 是 三倍的 k 减去 两倍的 d，按照极限考虑，j 的最小取值为为 -200（`k=0, d=100`），最大取值为 300（`k=100, d=0`）。

一般情况下，j 的取值范围基本上在 -10~110 内波动，有时候会稍微超过 100 或稍微低至 0。以贵州茅台从 2001-08-27 ~ 2023-10-20 的数据来看，超过 100 的交易日占比 7%（`376/5373`），而低于 0 的交易日占比 7.5%（`403/5373`）。最高达到过 129.62（2006-04-19），最低到过 -31.24（2006-03-13）。所以拿两个例子来感受下计算过程，一个是 2023-07-25（`j=110.80`），另一个是 2023-10-19（`j=-2.60`）。

贵州茅台在 2023-07-25 的数据如下所示，股价快速攀升，j 值就会非常大。_窗口内 min(最低价)_ 为 `1713.80`， _窗口内 max(最高价)_ 为 `1828.88`。而当天收盘价为 `1828.55`，与 _窗口内 max(最高价)_ 仅仅有 3.3 毛钱的缺口。在这种情况下，rsv 就会非常大（`99.71`，`114.75/115.08`）。快线 k 在 _昨日 k_ 的基础上 加上 `1/3` 的 rsv，慢线 d 在 _昨日 d_ 的基础上 加上 `1/3` 的 k（即 对于 rsv 而言，仅仅取了 `1/9` ）。 j 用 3 倍快线（`263.71`）减去 2 倍慢线（`142.9`）等于 `110.80`。

```
   trade_date          K          D           J    close  lowest_low  highest_high        RSV
14 2023-07-21  66.595025  58.846389   82.092295  1771.30     1702.10       1772.50  98.295455
15 2023-07-24  76.994362  64.895713  101.191658  1771.15     1711.33       1772.50  97.793036
16 2023-07-25  84.567322  71.452916  110.796134  1828.55     1713.80       1828.88  99.713243
17 2023-07-26  87.681922  76.862585  109.320596  1828.55     1713.80       1835.99  93.911122
18 2023-07-27  87.825492  80.516887  102.442702  1838.03     1713.80       1854.79  88.112632
```

贵州茅台在 2023-10-19 的数据如下所示，当股价快速下跌，j 值会出现非常小的值（`-2.61`）。我们来看下具体情况，当天股价大幅下跌（收盘价 `1630.00`），并且窗口内最低价的最小值也在该天出现（_窗口内 min(最低价)_ `1626.03`），而 _窗口内 max(最高价)_ 为 `1798.98`。收盘价与 _窗口内 min(最低价)_ 之间只差了 `3.97` 块钱，而 _窗口内 max(最高价)_ 与 _窗口内 min(最低价)_ 之间却有 `172.95` 块钱的差距。所以计算出来的 rsv 值就非常小了（`2.30`，`3.97/172.95`）。所以，快线 k、慢线 d 都有不同程度的下降（k: `9.09`；d: `14.95`）。所以 按照公式 j 计算低于零值（`-2.60`）。

```
   trade_date          K        RSV      pre_k          D          J    close  lowest_low  highest_high
70 2023-10-17  13.243333   8.510638  15.609680  20.565948  -1.401897  1726.00     1716.00       1833.50
71 2023-10-18  12.499287  11.011195  13.243333  17.877061   1.743739  1728.00     1716.00       1824.98
72 2023-10-19   9.098012   2.295461  12.499287  14.950711  -2.607388  1630.00     1626.03       1798.98
73 2023-10-20  11.309873  15.733596   9.098012  13.737098   6.455422  1645.00     1616.25       1798.98
```

kdj 的关键就是 rsv 的计算，因为 k、d、j 这三个指标都是在 rsv 之上进行“平滑”处理。k 的计算是取了 `1/3` 的 rsv，而 d 在取了 `1/9` 的 rsv（`1/3` 的 k）， j 是 `7/9` 的 rsv （`3k-2d`）。rsv 成分越高，对当日股价变化就会更敏感，所以敏感程度由高到低为 j、k、d。敏感就意味着变化速度快，稳定性差，可靠性也越低。

rsv 可以看成是一个由 close 切分出两个线段 `a`，`b` 之间的比较（`a = wins_max(high)-close`、`b = close-wins_min(low)`，`rsv = b/(a+b)*100`）。那就会有三种情况：1. `a > b`（`rsv < 50`）说明 收盘价 离 _窗口内 min(最低价)_ 比较近，说明空方力量占优，大多数人都看空；2. `a < b`（`rsv > 50`）说明 收盘价 离 _窗口内 max(最高价)_ 比较近，说明多方力量占优，大多数人都看多；3. `a = b`（`rsv = 50`）说明 收盘价没有明显的偏向，空方和多方力量五五开。对于 k、d、j 也是如此。所以将 50 看成 零轴，另外还有两个比较特殊的区域，超买区（k>90，d>80），超卖区（k<10，d<20）。

当 j 线从零轴下突破 k 线和 d 线时，说明空方力量减弱，股价短期将向上，可以少量建仓。当 j 线向上穿越 k 线和 d 线之后，迅速向上运动，说明股价有一波较大的上涨行情，投资者可以考虑加仓或者持股待涨。当 j 线经过一段快速向上的运动之后，在超买区（k:90, d:80）向下掉头的时候，说明股价短期上涨过快，可能进入一波调整期，可以考虑减仓。当 k 线也开始从高位向下掉头的时候，说明中短期上涨行情已经结束，应该考虑清仓。当 k、d、j 三条线同时从高位向下，并且 j 线穿越 k 线和 d 线（kdj 死叉），说明必然股价下跌趋势形成，需要立刻清仓，并持币观望。具体交易逻辑总结如下。

- 底部，j 线拐头上翘，可以少量建仓 5%~10%
- 继续向上，kdj 底部形成金叉，建仓 20%~40%
- kdj 三条线继续向上运动，穿越零轴，加仓 20%~40%或持股待涨
- kdj 从高位形成死叉并同时向下，立刻清仓；kdj 三条线同时向下，立刻清仓！！

当股价 k 线图一浪比一浪高，而 kdj 在图形上整体是一浪比一浪低的走势，称之为顶背离。一般出现在高位，其内在逻辑在于股价虽然有所提升，但多方力量已经衰竭，有下跌趋势，建议卖出。当股价 k 线图一浪比一浪低，而 kdj 在图形上整体是一浪比一浪高走势，称之为底背离。一般出现在底部，说明空方力量衰竭，有上涨的趋势，建议买入。

KDJ 存在钝化问题，简单说就是当 kdj 处于超买和超卖区域时，股价依然活跃上涨或继续下跌时，指标上面并没有明显变化，甚至走出了相反的走势的现象，或者出现给出“假”金叉入场信号。解决办法 1：放大周期（3 日 kdj `wins=27`，最多 5 日 kdj `wins=45`，不能过大），如果未出现共振，则是假信号；方法 2：MACD 共振法；方法 3：K 线浪形法，由于 kdj 钝化在 K 线上的表现是上升波浪和下降波浪，比如在上升波浪中回调的时候，kdj 容易给出死叉信号，但该死叉信号是假信号。所以，短周期 kdj 应该作为调整仓位的信号，而长周期 kdj 作为清仓的信号。

**参考**

1. [知乎话题：如何正确理解 KDJ](https://www.zhihu.com/question/27652388)
2. [知乎@股海老张：KDJ 的详细图解和相关指示意义](https://zhuanlan.zhihu.com/p/99364915)

### BOLL

布林线指标 Bollinger Bands, 是研判股价运动趋势的一种中长期技术分析工具. 一共有三根线组成, 中轨线, 上轨线, 下轨线.

假设收盘价$CLOSE=\{p_1,p_2,...,p_n\}$, 布林线观察窗口为 20 日, 且上下轨取 2 倍标准差

$$
mid_i = \frac{p_{i-19} + p_{i-18} + ... + p_{i}}{20}
$$

$$
std_i = \sqrt{\frac{\sum_{k=i-19}^{i}(p_k - mid_i)^2}{20}}
$$

$$
upper_i = mid_i + 2 \times std_i
$$

$$
lower_i = mid_i - 2 \times std_i
$$

代码实现如下

```py
def boll(close, wins=20, k=2) -> pd.DataFrame:
    mid = close.rolling(window=wins).mean()
    std = close.rolling(window=wins).std()
    upper = mid + k * std
    lower = mid - k * std

    mid = pd.Series(mid, name='mid')
    upper = pd.Series(upper, name='upper')
    lower = pd.Series(lower, name='lower')
    df = pd.concat([mid, upper, lower], axis=1)

    return df
```

#### 参考

1. [【知乎】怎么看懂「布林线（Boll）指标」，如何分析与运用？](https://www.zhihu.com/question/384284854)
2. [【知乎】图文详解：BOLL 线的真正用法，胜过读万本股票书](https://zhuanlan.zhihu.com/p/47995278)
